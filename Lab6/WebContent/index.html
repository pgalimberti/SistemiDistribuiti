<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Lab 6</title>
<script type="text/javascript" src="js/jquery-3.3.1.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBug4z348l-Ja3uW-VNHDPB_npG92vzlAY&sensor=false"></script>
<style>
	#map {
	 height: 600px;
	 width: 100%;
	}
</style>
<script>
	$(document).ready(function() {
		var map;
		var marker = [];
		var infoWindow = [];
		var coordinates = [];
		
		getCoordinates(coordinates,marker,infoWindow);

	});

	function getMap(coordinates,marker,infoWindow) {
		//var testMarker = {lat: 45.4853, lng: 9.20923};		
		var mapOptions = {
				center : new google.maps.LatLng(45.4640, 9.1916),
				zoom : 11.7,
				mapTypeId : google.maps.MapTypeId.ROADMAP
			};
		
		 map = new google.maps.Map(document.getElementById('map'), mapOptions);
		 
		 setMarker(map,coordinates,marker,infoWindow);
	}
	
	function setMarker(map,coordinates,marker,infowindow){
		for ( var i = 0; i < coordinates.length; i++){
			//console.log(coordinates[i]);
			string = "prova"+i;
			infowindow[i] = new google.maps.InfoWindow(
				{
					content : string
				});
			marker[i] = new google.maps.Marker({
		          position: coordinates[i],
		          map: map,
		          title: coordinates[i].name,
		          posizione : i
		        });
			google.maps.event.addListener(marker[i], 'click', function(e){
				infowindow[this.posizione].open(map,this);
			});
/* 			marker[i].addListener('click', function() {
		          infowindow[i].open(map, this);
		        }); */
		 }
	}
	
	function getCoordinates(coordinates,marker,infowindow){

		var endpointUrl = 'https://query.wikidata.org/sparql',
	    sparqlQuery = "SELECT ?metropolitana_di_Milano ?metropolitana_di_MilanoLabel ?linea_di_collegamento ?linea_di_collegamentoLabel ?coordinate_geografiche \n" +
	        "WHERE {\n" +
	        "  SERVICE wikibase:label { bd:serviceParam wikibase:language \"[AUTO_LANGUAGE],it\". }\n" +
	        "  ?metropolitana_di_Milano wdt:P361 wd:Q735559.\n" +
	        "  OPTIONAL { ?metropolitana_di_Milano wdt:P81 ?linea_di_collegamento. }\n" +
	        "  OPTIONAL { ?metropolitana_di_Milano wdt:P625 ?coordinate_geografiche. }\n" +
	        "}",
	    settings = {
	        headers: { Accept: 'application/sparql-results+json' },
	        async: false,
	        data: { query: sparqlQuery }
	    };

		$.ajax( endpointUrl, settings ).then( function ( data ) {
			var temp = {};
		    console.log( data );
		    var a = data.results.bindings[0].coordinate_geografiche.value;
		    a.substring(6,(a.length-1)).split(" ");
		    temp["lat"] = a[0];
		    temp["lng"] = a[1];
		    $.each(data.results.bindings, function(i,row){
		    	var temp = {};
		    	if(row.coordinate_geografiche != undefined){
			    	var tempCoords = row.coordinate_geografiche.value;
			    	var splitted = tempCoords.substring(6,(tempCoords.length-1)).split(" ");
			    	temp["lat"] = parseFloat(splitted[1]);
			    	temp["lng"] = parseFloat(splitted[0]);
			    	coordinates.push(temp);
		    	}
		    });
		    //console.log( data.results.bindings[0].coordinate_geografiche.value );
		    //console.log(coordinates);
		    getMap(coordinates,marker,infowindow);
		} );
	}
	/*
	function testQuery(){
		
		var URL = "http://dbpedia.org/sparql?default-graph-uri=http://dbpedia.org&query=";
		var query = "select ?name where " +
		"{_:var dct:subject <http://dbpedia.org/resource/Category:Milan_metro_lines>;" +
		"dbo:routeStart ?name" +
		"}";
		var options = "&debug=on&timeout=&format=json&save=display&fname=";
		var ajaxURL = URL + query + options;
		$.getJSON(ajaxURL, {}, function(data) {
			$.each(data.results.bindings, function(i,row){
				console.log(row.name.value);
			});
		});
		
	}
	
	
	function test(){
		var endpointUrl = 'https://query.wikidata.org/sparql',
	    sparqlQuery = "SELECT ?linea_M1 ?logo WHERE {\n" +
	        "  SERVICE wikibase:label { bd:serviceParam wikibase:language \"[AUTO_LANGUAGE],en\". }\n" +
	        "  ?linea_M1 wdt:P527 wd:Q2400801.\n" +
	        "  OPTIONAL { ?linea_M1 wdt:P154 ?logo. }\n" +
	        "}\n" +
	        "LIMIT 100",
	    settings = {
	        headers: { Accept: 'application/sparql-results+json' },
	        data: { query: sparqlQuery }
	    };

	$.ajax( endpointUrl, settings ).then( function ( data ) {
	    console.log( data );
	} );
	}*/
</script>
</head>
<body>
	<div class="wrapper">
		<div class="content">
			<div class="main">
				<div id="map"></div>
			</div>
		</div>

	</div>
</body>
</html>