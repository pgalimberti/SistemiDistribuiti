<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Lab 6</title>
<script type="text/javascript" src="js/jquery-3.3.1.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBug4z348l-Ja3uW-VNHDPB_npG92vzlAY&sensor=false"></script>
<style>
	#map {
	 height: 600px;
	 width: 100%;
	}
</style>
<script>
var map;
var marker;
var infoWindow;
var coordinates = [];

$(document).ready(function() {	
	getCoordinates(coordinates,marker,infoWindow);
});
	
	function getCoordinates(coordinates,marker,infowindow){
		var endpointUrl = 'https://query.wikidata.org/sparql',
	    sparqlQuery = "SELECT ?metropolitana_di_Milano ?metropolitana_di_MilanoLabel ?linea_di_collegamento ?linea_di_collegamentoLabel ?coordinate_geografiche \n" +
	        "WHERE {\n" +
	        "  SERVICE wikibase:label { bd:serviceParam wikibase:language \"[AUTO_LANGUAGE],it\". }\n" +
	        "  ?metropolitana_di_Milano wdt:P361 wd:Q735559.\n" +
	        "  OPTIONAL { ?metropolitana_di_Milano wdt:P81 ?linea_di_collegamento. }\n" +
	        "  OPTIONAL { ?metropolitana_di_Milano wdt:P625 ?coordinate_geografiche. }\n" +
	        "}",
	    settings = {
	        headers: { Accept: 'application/sparql-results+json' },
	        async: false,
	        data: { query: sparqlQuery }
	    };

		$.ajax( endpointUrl, settings ).then( function ( data ) {
			var temp = {};
		    console.log( data );
		    /*var a = data.results.bindings[0].coordinate_geografiche.value;
		    a.substring(6,(a.length-1)).split(" ");
		    temp["lat"] = a[0];
		    temp["lng"] = a[1];*/
		    $.each(data.results.bindings, function(i,row){
		    	var temp = {};
		    	if(row.coordinate_geografiche != undefined){
			    	var tempCoords = row.coordinate_geografiche.value;
			    	var splitted = tempCoords.substring(6,(tempCoords.length-1)).split(" ");
			    	temp["lat"] = parseFloat(splitted[1]);
			    	temp["lng"] = parseFloat(splitted[0]);
			    	temp["name"] = row.metropolitana_di_MilanoLabel.value;
			    	temp["linea"] = row.linea_di_collegamentoLabel.value;
			    	coordinates.push(temp);
		    	}
		    });
		    getMap(coordinates,marker,infowindow);
		} );
	}	

	function getMap(coordinates,marker,infoWindow) {		
		var mapOptions = {
				center : new google.maps.LatLng(45.4640, 9.1916),
				zoom : 12,
				mapTypeId : google.maps.MapTypeId.ROADMAP
			};
		
		 map = new google.maps.Map(document.getElementById('map'), mapOptions);
		 
		 setMarker(map,coordinates,marker,infoWindow);
	}
	
	function setMarker(map,coordinates,marker,infowindow){
		for ( var i = 0; i < coordinates.length; i++){
			
			var html = "<div><span>"+coordinates[i].name+"</span> <span>"+coordinates[i].linea+"</span></div>";
			
			var latlng = new google.maps.LatLng(coordinates[i].lat, coordinates[i].lng);
			
			var marker = new google.maps.Marker({
				position: latlng,
				map: map,
				html: html
			});
			  
			google.maps.event.addListener(marker, "click", function() {
		        if (infowindow) infowindow.close();
		        infowindow = new google.maps.InfoWindow({
		            content: this.html
		        });
		        infowindow.open(map, this);
		    });
		}		 
	}
</script>
</head>
<body>
	<div class="wrapper">
		<div class="content">
			<div class="main">
				<div id="map"></div>
			</div>
		</div>

	</div>
</body>
</html>